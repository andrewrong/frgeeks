title: redis持久化(简单描述)
date: 2014-10-28 22:17:29
categories: redis
tags: redis
---

redis在我公司，基本上只是用来做缓存使用，所以没有做持久化;在这之前我也主观的感觉redis仅仅只是适合当做缓存使用，虽然有持久化，但是个人对此的感觉是它仅仅是备份，没有数据库那么强的恢复机制。今天主要是要了解redis的两种持久化机制，一种是RDB，一种是AOF。

### 1. RDB

RDB持久化，从本质上来说其实是一种备份，redis可以设置条件，当条件满足的时候会想磁盘中dump一份文件，文件的基本内容是存放在redis数据库中的内容，当然也包含一些数据库信息。有三种方式可以让redis服务器创建RDB文件:

    1. 客户端发送save命令;
    2. 客户端发送bgsave命令;
    3. redis.conf中的save的配置条件被触发的话，会自动创建RDB文件;

关于save和bgsave的区别是，save是一个同步操作，而bgsave是一个异步操作；当执行save的时候服务器的进程会被阻塞住，在此期间服务器是不能处理客户端的请求；而bgsave则是一个异步的操作，redis的bgsave的实现原理应该是创建了一个子进程，异步执行;

关于在redis.conf中save的配置。我们可以设置什么时候什么条件可能会触发创建RDB文件的创建。通过有几种配置：

	save <second> <changes> //当离上次创建RDB的时间x秒的时候，并且数据库被修改了n次的时候就创建rdb文件

save配置触发的是bgsave命令的执行，下面是redis.conf的默认配置;

	save 900 1 
	save 300 10 
	save 60 10000

三个条件任何一个成立就会触发bgsave命令;

### 2. AOF

AOF持久化的本质类似于数据库的binlog日志文件，因为RDB是一个粗粒度的持久化，频繁的创建文件是一个很耗费性能的问题，而且如果在下次rdb创建之前，服务器挂了话就会导致大量的数据丢失。而AOF也就是为了应对这种现象而产生的，AOF保存的是每一次修改redis内容的命令，和binlog超级像。

使用AOF持久化的具体流程如下：

    1. 当有修改操作的时候
    2. 先把这条命令保存到AOF的文件尾部
    3. 然后更新redis的内容

这里会遇到的问题是，虽然每一次都是写入到文件中去的，但是我们都知道不同操作系统都会有写缓存的存在，而且不同操作系统还不一样的，所以所谓的写入其实有可能只是写到了缓存而已，到了一定的时间才会把内容真正的存放到文件中.redis对这个刷入到文件的时机做成了可配置的(appendfsync):

    appendfsync:no
    appendfsync:always
    appendfsync:everysec

这三种模式的区别在于，no是完全依赖于操作系统本身，always是每修改就更新，everysec：每一秒刷入一次。当然redis对everysec做了优化，所以默认的everysec的速度和no基本差不多。

关于AOF还有一个问题就是，时间越长AOF文件就会越大，恢复时间也就越长，最搞的是很多操作是多余的，比如a=4，a--，a++，其实经过这次操作a的值就没有变化，所以每隔一段时间会把redis的AOF重写一遍，重写以后的AOF文件比以前更加小，但是功能是一样的.

	auto-aof-rewrite-percentage 100 
	auto-aof-rewrite-min-size 64mb

具体的含义可以查阅redis的文档，其实挺拗口的。

### 3. 总结

关于redis的持久化只是大概讲了一下，有很多深层次的都没有讲，比如在同步的过程中，服务器的内容变化了要如何处理等，不过后期我对这部分的内容比较清楚了再写。
	
